#!/usr/bin/env bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/.."

if [ "$1" = "cli" ]; then
  react-native init $2 --version 0.59.10
elif [ "$1" = "expo" ]; then
  expo init -t blank --yarn $2
else
  echo "Unknown project type; enter one of: cli, expo"
  exit 1
fi

cd $2
git init .
git add .
git commit -m "Create react native app with $1"

cp "${DIR}/template/.npmrc" .npmrc
git add .
git commit -m "Prevent package lock"

if [ "$1" = "expo" ]; then
  yarn add --dev jest babel-jest
  git add .
  git commit -m "Add Jest"
fi

yarn add --dev react-native-testing-library
git add .
git commit -m "Add RNTL"

if [ "$1" = "cli" ]; then
  yarn add --dev detox
  detox init -r jest
  git add .
  git commit -m "Add Detox"
fi

if [ "$1" = "cli" ]; then
  yarn remove @react-native-community/eslint-config
elif [ "$1" = "expo" ]; then
  yarn add --dev eslint
fi
yarn add --dev babel-eslint \
               eslint-config-codingitwrong \
               eslint-config-prettier \
               eslint-plugin-import \
               eslint-plugin-jest \
               eslint-plugin-jsx-a11y \
               eslint-plugin-prettier \
               eslint-plugin-react \
               prettier
cp "${DIR}/template/.prettierrc.js" .prettierrc.js
if [ "$1" = "cli" ]; then
  yarn add --dev detox eslint-plugin-detox
  cp "${DIR}/template/.eslintrc.cli.js" .eslintrc.js
elif [ "$1" = "expo" ]; then
  cp "${DIR}/template/.eslintrc.expo.js" .eslintrc.js
fi
git add .
git commit -m "Switch to CodingItWrong ESLint and Prettier"

yarn add react-navigation \
         react-native-gesture-handler
react-native link react-native-gesture-handler
git add .
git commit -m "Add React Navigation"

yarn add formik yup
git add .
git commit -m "Add Formik and Yup"

yarn add lodash-es
git add .
git commit -m "Add Lodash-ES"

yarn add -D reactotron-react-native
cp "${DIR}/template/ReactotronConfig.js" ReactotronConfig.js
git add .
git commit -m "Add Reactotron"

npx -p @storybook/cli sb init --yes
git add .
git commit -m "Add Storybook"

yarn add axios
mkdir src
if [ "$1" = "cli" ]; then
  yarn add react-native-config
  react-native link react-native-config
  cp -r "${DIR}/template/src/api.cli" src/api
  cp "${DIR}/template/src/api.js" src/api/remote.js
  cp "${DIR}/template/.env" .env
  cp "${DIR}/template/.env.detox" .env.detox
elif [ "$1" = "expo" ]; then
  cp "${DIR}/template/src/api.js" src/api.js
fi
git add .
git commit -m "Add Axios"

yarn add mobx \
         mobx-react \
         @reststate/mobx
git add .
git commit -m "Add @reststate/mobx"

cp "${DIR}/template/App.js" App.js
cp "${DIR}/template/src/stores.js" src/stores.js
cp -r "${DIR}/template/src/screens" src/screens
git add .
git commit -m "Add sample app content"

if [ "$1" = "cli" ]; then
  cp "${DIR}/template/README.cli.md" README.md
fi
if [ "$1" = "expo" ]; then
  cp "${DIR}/template/README.expo.md" README.md
fi
git add .
git commit -m "Add default README"
