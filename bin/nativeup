#!/usr/bin/env bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/.."

if [ "$1" = "cli" ]; then
  react-native init $2
elif [ "$1" = "expo" ]; then
  expo init -t blank --yarn $2
else
  echo "Unknown project type; enter one of: cli, expo"
  exit 1
fi

cd $2
git init .
git add .
git commit -m "Create react native app with $1"

cp "${DIR}/template/.npmrc" .npmrc
git add .
git commit -m "Prevent package lock"

if [ "$1" = "cli" ]; then
  yarn remove jest babel-jest
  git add .
  git commit -m "Remove Jest"
fi

yarn add --dev mocha \
               chai \
               sinon \
               sinon-chai
git add .
git commit -m "Add Mocha"

yarn add --dev enzyme \
               enzyme-adapter-react-16 \
               @jonny/react-native-mock
git add .
git commit -m "Add Enzyme"

cp -r "${DIR}/template/test" test
git add .
git commit -m "Configure Mocha"

yarn add --dev detox
detox init -r mocha
if [ "$1" = "expo" ]; then
  yarn add --dev detox-expo-helpers expo-detox-hook

  curl https://dpq5q02fu5f55.cloudfront.net/Exponent-2.10.0.tar.gz -o Exponent.tar.gz
  mkdir -p bin/Exponent.app
  tar xzvf Exponent.tar.gz --directory bin/Exponent.app
  rm Exponent.tar.gz
  echo "bin/Exponent.app" >> .gitignore
fi
git add .
git commit -m "Add Detox"

yarn add -D eslint \
            babel-eslint \
            eslint-config-codingitwrong \
            eslint-config-prettier \
            eslint-plugin-detox \
            eslint-plugin-import \
            eslint-plugin-jsx-a11y \
            eslint-plugin-prettier \
            eslint-plugin-react \
            prettier
cp "${DIR}/template/.eslintrc.js" .eslintrc.js
cp "${DIR}/template/.prettierrc.js" .prettierrc.js
git add .
git commit -m "Add ESLint and Prettier"

yarn add lodash-es
git add .
git commit -m "Add Lodash-ES"

yarn add -D reactotron-react-native
cp "${DIR}/template/ReactotronConfig.js" ReactotronConfig.js
git add .
git commit -m "Add Reactotron"

npx -p @storybook/cli sb init
git add .
git commit -m "Add Storybook"

yarn add axios \
         @codingitwrong/react-login
cp "${DIR}/template/api.js" api.js
cp "${DIR}/template/Auth.js" Auth.js
cp "${DIR}/template/App.js" App.js
git add .
git commit -m "Add OAuth2"

yarn add mobx \
         mobx-react \
         @reststate/mobx
git add .
git commit -m "Add @reststate/mobx"

if [ "$1" = "cli" ]; then
  cp "${DIR}/template/README.cli.md" README.md
fi
if [ "$1" = "expo" ]; then
  cp "${DIR}/template/README.expo.md" README.md
fi
git add .
git commit -m "Add default README"
